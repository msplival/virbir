#!/usr/bin/bash

# mandatory
vm_name="test-instance"

# defaults, but configurable 
vm_cpus=4
vm_mem=8192
vm_disk=20G
vm_storagepool=default
imagefile=/mnt/enchilada/iso/Ubuntu/ubuntu-22.04.4-live-server-amd64.iso
vm_user=mario
vm_importid="gh:msplival"
vm_pwd=ubuntu

hashed_passwrod=$(mkpasswd --method=SHA-512 "$vm_pwd")

workTempDir=$(mktemp -d)

USERNAME=mario
USER_SHELL=bash

autoinstall_yaml=$(cat <<EOF
#cloud-config
users:
  - name: $USERNAME
    shell: $USER_SHELL

package_update: true
package_upgrade: true
EOF
)


echo -e $autoinstall_yaml > $workTempDir/user-data
touch $workTempDir/meta-data

echo $workTempDir/user-data
cat $workTempDir/user-data

exit 5
virt-install \
    --name $vm_name \
    --memory $vm_mem \
    --vcpus=${vm_cpus} \
    --osinfo ubuntu22.04 \
    --cdrom "${imagefile}" \
    --cloud-init="meta-data=$workTempDir/meta-data,user-data=$workTempDir/user-data" \
    --autoconsole graphical



