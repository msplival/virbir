#!/usr/bin/bash

# defaults, but configurable 
vm_cpus=2
vm_mem=2048
vm_disk=20G
vm_storagepool=default
vm_user=$USER
vm_importid="gh_msplival"
vm_pwd=ubuntu

FOO=$(getopt -o n:i:cmdp --longoptions name:,image:,cpus,memory,disksize,pool -n "virbir" -- "$@" )
eval set -- "$FOO"
while true; do
    case "$1" in
    -n | --name ) vm_name="$2"; shift 2;; 
    -i | --image ) imagefile="$2"; shift 2;;
    -c | --cpus ) vm_cpus="$2"; shift 2;;
    -m | --memory ) vm_mem="$2"; shift 2;;
    -d | --disksize ) vm_disk="$2"; shift 2;;
    -p | --pool ) vm_storagepool="$2"; shift 2;;
    --) shift ; break ;;
    esac
done

if [[ -z $vm_name ]]; then
  echo "Please provide virtual machina name."
  exit 1
fi

if [[ -z $imagefile ]]; then 
  echo "Please provide iso image to boot from."
  exit 2
fi

hashed_password=$(mkpasswd --method=SHA-512 "$vm_pwd")

workTempDir=$(mktemp -d)

autoinstall_yaml=$(cat <<EOF
#cloud-config
autoinstall:
  version: 1
  identity:
    hostname: $vm_name
    password: "$hashed_password" #ubuntu
    username: $vm_user
  locale: en_US
  storage:
    layout:
      name: direct
  # seems these are needed for 24.04      
  ssh:
    install-server: true
  packages:
    - ssh-import-id
  user-data: 
    package_upgrade: true
    apt:
      http_proxy: 'http://192.168.122.1:3142/'
    users:
    - name: $vm_user
      ssh_import_id:
        - $vm_importid
      sudo: ALL=(ALL) NOPASSWD:ALL
      groups: sudo,admin,adm
      shell: /bin/bash
      lock_passwd: false
EOF
)

echo  "$autoinstall_yaml" > "$workTempDir"/user-data
touch "$workTempDir"/meta-data

virt-install \
    --name "$vm_name" \
    --memory "$vm_mem" \
    --vcpus="${vm_cpus}" \
    --osinfo ubuntu22.04 \
    --cdrom "${imagefile}" \
    --cloud-init="meta-data=$workTempDir/meta-data,user-data=$workTempDir/user-data" \
    --autoconsole graphical

rm -rf "$workTempDir"

